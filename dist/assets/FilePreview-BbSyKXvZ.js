import{f as g,j as x,g as C,I as U,h as k,i as T}from"./main.bundle.builder-BiUOz8vX.js";import{P as L,v as E}from"./play_video-BFGyulc6.js";import{_ as F,c as p,a,b as h,w as n,e as m,f as w,v as y,g as v,h as V,d as D,o as c}from"./index-EqXksqRE.js";class M extends HTMLElement{#i;#t;#e;#o;constructor(){super(),this.#i=this.attachShadow({mode:"open"}),this.#t=document.createElement("common-file-preview"),this.#i.appendChild(this.#t);const e=document.createElement("style");e.textContent=`
            :host {
                display: block;
                box-sizing: border-box;
                overflow: hidden;
            }
            common-file-preview, video {
                width: 100%;
                height: 100%;
            }
            common-file-preview {
                overflow: auto;
            }
            video {
                object-fit: contain;
                background-color: #000;
            }
        `,this.#i.appendChild(e)}connectedCallback(){}disconnectedCallback(){this.#e&&this.#e!==!0&&g(this.#e),this.#o&&this.#o()}async load(e,s,r,t,l){if(this.#e)throw new Error("already loaded");if(t!=="video"){const u=new Blob([await e(0,r)]),f=new Blob([await x(u,s)],{type:t}),d=URL.createObjectURL(f);this.#t.init(()=>d,t,l),this.#e=!0,this.#o=()=>{URL.revokeObjectURL(d)};return}const o=document.createElement("video");o.controls=!0,o.playsInline=!0,this.#t.replaceWith(o),this.#t=o,this.#e=await C();const b=new U(e,r);await k(this.#e,b,s),this.#o=await L(o,async(u,f,d)=>await T(this.#e,u,f,d))}}customElements.define("simple-data-crypto-file-preview",M);console.log("play-video-streamed version:",E());const P={data(){return{file:null,fileUrl:"",password:"",mode:"local",type:"text/plain",shouldCreate:!1}},methods:{guessFileType(i=""){if(!i)return"text/plain";i.endsWith(".enc")&&(i=i.slice(0,-4));const e=i.split(".").pop().toLowerCase();switch(e){case"txt":return"text/plain";case"jpg":case"jpeg":case"png":case"gif":case"bmp":case"webp":return"image";case"mp4":return"video";case"mp3":case"wav":return"audio/"+e;case"pdf":return"application/pdf";case"docx":return"docx";default:return"text/plain"}},updateGuessedType(){if(this.mode==="local")this.type=this.guessFileType(this.$refs.filebox?.files?.[0]?.name);else if(this.mode==="remote")try{const i=new URL(this.fileUrl);this.type=this.guessFileType(i.pathname)}catch{}},async getFileSize(i){const e=new AbortController,s=await fetch(i,{signal:e.signal});if(!s.ok)throw new Error(`Failed to fetch file size: ${s.statusText}`);const r=+s.headers.get("Content-Length");if(isNaN(r))throw new Error("Content-Length header is missing or invalid");return e.abort(),r},async doPreview(){if(this.file=this.mode==="local"&&this.$refs.filebox.files?.[0],!this.file&&this.mode==="local"){alert("请选择一个文件");return}try{this.$refs.dlg.showModal(),this.shouldCreate=!0;const i=this.mode==="local"?async(s,r)=>{const t=this.file.slice(s,r);return new Uint8Array(await t.arrayBuffer())}:async(s,r,t)=>{const l=await fetch(this.fileUrl,{headers:{Range:`bytes=${s}-${r-1}`},method:"GET",signal:t});return new Uint8Array(await l.arrayBuffer())};await new Promise((s,r)=>{this.$nextTick(()=>this.$nextTick(s))});const e=this.type==="docx"?"File.docx":"File";await this.$refs.preview.load(i,this.password,this.mode==="local"?this.file.size:await this.getFileSize(this.fileUrl),this.type,e)}catch(i){console.error(i),alert(i),this.$refs.dlg.close(),this.shouldCreate=!1}},closeDialog(){this.$refs.dlg.close(),this.shouldCreate=!1},handleDialogClose(){}}},B={class:"mode-selector"},R={key:0,type:"file",ref:"filebox"},j=["disabled"],S={key:0,ref:"preview",style:{flex:"1"}};function z(i,e,s,r,t,l){return c(),p("div",{class:"file-preview",onChange:e[10]||(e[10]=(...o)=>l.updateGuessedType&&l.updateGuessedType(...o))},[a("div",B,[a("label",null,[n(a("input",{type:"radio","onUpdate:modelValue":e[0]||(e[0]=o=>t.mode=o),value:"local"},null,512),[[w,t.mode]]),e[11]||(e[11]=m(" 本地文件 "))]),a("label",null,[n(a("input",{type:"radio","onUpdate:modelValue":e[1]||(e[1]=o=>t.mode=o),value:"remote"},null,512),[[w,t.mode]]),e[12]||(e[12]=m(" 在线文件 "))])]),t.mode==="local"?(c(),p("input",R,null,512)):h("",!0),t.mode==="remote"?n((c(),p("input",{key:1,type:"text","onUpdate:modelValue":e[2]||(e[2]=o=>t.fileUrl=o),placeholder:"输入文件URL"},null,512)),[[y,t.fileUrl]]):h("",!0),n(a("input",{type:"password","onUpdate:modelValue":e[3]||(e[3]=o=>t.password=o),placeholder:"输入解密密码",onChange:e[4]||(e[4]=v(()=>{},["stop"]))},null,544),[[y,t.password]]),n(a("select",{"onUpdate:modelValue":e[5]||(e[5]=o=>t.type=o),onChange:e[6]||(e[6]=v(()=>{},["stop"]))},e[13]||(e[13]=[D('<option value="text/plain" data-v-299644be>文本</option><option value="image" data-v-299644be>图片</option><option value="video" data-v-299644be>视频</option><option value="audio/mp3" data-v-299644be>音频</option><option value="application/pdf" data-v-299644be>PDF</option><option value="docx" data-v-299644be>Microsoft Office 文档</option>',6)]),544),[[V,t.type]]),a("button",{onClick:e[7]||(e[7]=(...o)=>l.doPreview&&l.doPreview(...o)),disabled:!t.fileUrl&&t.mode==="remote"},"预览",8,j),a("dialog",{style:{width:"100%",height:"100%",display:"flex","flex-direction":"column",overflow:"hidden"},ref:"dlg",onClose:e[9]||(e[9]=(...o)=>l.handleDialogClose&&l.handleDialogClose(...o))},[t.shouldCreate?(c(),p("simple-data-crypto-file-preview",S,null,512)):h("",!0),a("button",{onClick:e[8]||(e[8]=(...o)=>l.closeDialog&&l.closeDialog(...o)),style:{"margin-top":"0.5em"}},"关闭")],544)],32)}const H=F(P,[["render",z],["__scopeId","data-v-299644be"]]);export{H as default};
//# sourceMappingURL=FilePreview-BbSyKXvZ.js.map
