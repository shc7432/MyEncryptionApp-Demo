{"version":3,"file":"simple-data-crypto-file-preview-CXZOOa99.js","sources":["../../src/simple-data-crypto-file-preview.js"],"sourcesContent":["import {\r\n    crypt_context_create,\r\n    crypt_context_destroy,\r\n    decrypt_stream_init,\r\n    decrypt_stream,\r\n    decrypt_blob,\r\n    InputStream,\r\n} from 'simple-data-crypto/builder';\r\nimport { PlayMp4Video } from 'play-video-streamed';\r\n\r\nclass HTMLSimpleDataCryptoFilePreviewElement extends HTMLElement {\r\n    #shadow;\r\n    #preview;\r\n    #ctx;\r\n    #cleanup;\r\n\r\n    constructor() {\r\n        super();\r\n        this.#shadow = this.attachShadow({ mode: \"open\" });\r\n        this.#preview = document.createElement(\"common-file-preview\");\r\n        this.#shadow.appendChild(this.#preview);\r\n        const style = document.createElement(\"style\");\r\n        style.textContent = `\r\n            :host {\r\n                display: block;\r\n                box-sizing: border-box;\r\n                overflow: hidden;\r\n            }\r\n            common-file-preview, video {\r\n                width: 100%;\r\n                height: 100%;\r\n            }\r\n            common-file-preview {\r\n                overflow: auto;\r\n            }\r\n            video {\r\n                object-fit: contain;\r\n                background-color: #000;\r\n            }\r\n        `;\r\n        this.#shadow.appendChild(style);\r\n    }\r\n\r\n    connectedCallback() {\r\n        \r\n    }\r\n\r\n    disconnectedCallback() {\r\n        if (this.#ctx && this.#ctx !== true) {\r\n            crypt_context_destroy(this.#ctx);\r\n        }\r\n        if (this.#cleanup) {\r\n            this.#cleanup();\r\n        }\r\n    }\r\n\r\n    async load(fileReader, password, size, type, fileName) {\r\n        if (this.#ctx) {\r\n            throw new Error(\"already loaded\");\r\n        }\r\n        if (type !== \"video\") {\r\n            // 其他文件类型当成blob处理\r\n            const blob = new Blob([await fileReader(0, size)]);\r\n            const decryptedBlob = new Blob([await decrypt_blob(blob, password)], { type });\r\n            const url = URL.createObjectURL(decryptedBlob);\r\n            this.#preview.init(() => url, type, fileName);\r\n            this.#ctx = true;\r\n            this.#cleanup = () => {\r\n                URL.revokeObjectURL(url);\r\n            };\r\n            return;\r\n        }\r\n        // 处理视频\r\n        const np = document.createElement('video');\r\n        np.controls = true;\r\n        np.playsInline = true;\r\n        this.#preview.replaceWith(np);\r\n        this.#preview = np;\r\n        this.#ctx = await crypt_context_create(password);\r\n        const stream = new InputStream(fileReader, size);\r\n        await decrypt_stream_init(this.#ctx, stream, password);\r\n\r\n        this.#cleanup = await PlayMp4Video(np, (async (start, end, controller) => {\r\n            const buffer = await decrypt_stream(this.#ctx, start, end, controller);\r\n            return buffer;\r\n        }));\r\n    }\r\n}\r\n\r\ncustomElements.define(\"simple-data-crypto-file-preview\", HTMLSimpleDataCryptoFilePreviewElement);"],"names":["HTMLSimpleDataCryptoFilePreviewElement","#shadow","#preview","#ctx","#cleanup","style","crypt_context_destroy","fileReader","password","size","type","fileName","blob","decryptedBlob","decrypt_blob","url","np","crypt_context_create","stream","InputStream","decrypt_stream_init","PlayMp4Video","start","end","controller","decrypt_stream"],"mappings":"kFAUA,MAAMA,UAA+C,WAAY,CAC7DC,GACAC,GACAC,GACAC,GAEA,aAAc,CACV,QACA,KAAKH,GAAU,KAAK,aAAa,CAAE,KAAM,MAAM,CAAE,EACjD,KAAKC,GAAW,SAAS,cAAc,qBAAqB,EAC5D,KAAKD,GAAQ,YAAY,KAAKC,EAAQ,EACtC,MAAMG,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,YAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAkBpB,KAAKJ,GAAQ,YAAYI,CAAK,CACjC,CAED,mBAAoB,CAEnB,CAED,sBAAuB,CACf,KAAKF,IAAQ,KAAKA,KAAS,IAC3BG,EAAsB,KAAKH,EAAI,EAE/B,KAAKC,IACL,KAAKA,GAAQ,CAEpB,CAED,MAAM,KAAKG,EAAYC,EAAUC,EAAMC,EAAMC,EAAU,CACnD,GAAI,KAAKR,GACL,MAAM,IAAI,MAAM,gBAAgB,EAEpC,GAAIO,IAAS,QAAS,CAElB,MAAME,EAAO,IAAI,KAAK,CAAC,MAAML,EAAW,EAAGE,CAAI,CAAC,CAAC,EAC3CI,EAAgB,IAAI,KAAK,CAAC,MAAMC,EAAaF,EAAMJ,CAAQ,CAAC,EAAG,CAAE,KAAAE,CAAI,CAAE,EACvEK,EAAM,IAAI,gBAAgBF,CAAa,EAC7C,KAAKX,GAAS,KAAK,IAAMa,EAAKL,EAAMC,CAAQ,EAC5C,KAAKR,GAAO,GACZ,KAAKC,GAAW,IAAM,CAClB,IAAI,gBAAgBW,CAAG,CACvC,EACY,MACH,CAED,MAAMC,EAAK,SAAS,cAAc,OAAO,EACzCA,EAAG,SAAW,GACdA,EAAG,YAAc,GACjB,KAAKd,GAAS,YAAYc,CAAE,EAC5B,KAAKd,GAAWc,EAChB,KAAKb,GAAO,MAAMc,EAA6B,EAC/C,MAAMC,EAAS,IAAIC,EAAYZ,EAAYE,CAAI,EAC/C,MAAMW,EAAoB,KAAKjB,GAAMe,EAAQV,CAAQ,EAErD,KAAKJ,GAAW,MAAMiB,EAAaL,EAAK,MAAOM,EAAOC,EAAKC,IACxC,MAAMC,EAAe,KAAKtB,GAAMmB,EAAOC,EAAKC,CAAU,EAG5E,CACL,CAEA,eAAe,OAAO,kCAAmCxB,CAAsC"}