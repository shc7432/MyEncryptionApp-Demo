var Ne=Object.defineProperty;var Ce=(e,t)=>{for(var n in t)Ne(e,n,{get:t[n],enumerable:!0})};function Ve(e){return new Promise((t,n)=>{let i=document.createElement("script");i.src=e,i.onload=()=>t(i),i.onerror=a=>n(a),document.head.append(i)})}function Ie(e,t){return Reflect.has(globalThis,e)?Promise.resolve(Reflect.get(globalThis,e)):Ve(t).then(()=>Reflect.get(globalThis,e))}var Be=new Array(256);for(let e=0;e<256;e++)Be[e]=e.toString(16).padStart(2,"0");function K(e){if(!e||!(e instanceof Uint8Array))throw new TypeError("Input must be a Uint8Array");let t=e.length,n=new Array(t);for(let i=0;i<t;i++)n[i]=Be[e[i]];return n.join("")}var ke={get InvalidHexStringException(){throw new TypeError("Invalid hex string")}};function V(e){if(typeof e!="string")throw new TypeError("Input must be a string");let t=e.length;if(t%2!==0)throw new TypeError("Hex string must have even length");e=e.toLowerCase();let n=new Uint8Array(t>>1);for(let i=0;i<t;i+=2){let a=e.charCodeAt(i),o=e.charCodeAt(i+1),p=a>=97&&a<=102?a-87:a>=48&&a<=57?a-48:ke.InvalidHexStringException,s=o>=97&&o<=102?o-87:o>=48&&o<=57?o-48:ke.InvalidHexStringException;n[i>>1]=p<<4|s}return n}function L(e){let t=new Uint8Array(e);return crypto.getRandomValues(t),t}function Te(){let e=L(1);return new Int8Array(e)[0]}function _e(){let e=L(1);return new Uint8Array(e)[0]}function k(e,t="utf-8"){if(typeof e!="string")throw new TypeError("Input must be a string");if(t.toLowerCase()!=="utf-8")throw new Error("Only 'utf-8' encoding is supported");return new TextEncoder().encode(e)}function x(e,t="utf-8"){if(e instanceof Uint8Array||(e=new Uint8Array(e)),t.toLowerCase()!=="utf-8")throw new Error("Only 'utf-8' encoding is supported");return new TextDecoder().decode(e)}var W={};Ce(W,{BadDataException:()=>$,CannotDecryptException:()=>Y,CryptContextNotInitedException:()=>ie,CryptContextReleasedException:()=>se,CryptContextReusedException:()=>re,EncryptionError:()=>h,EncryptionVersionMismatchException:()=>U,EndOfFileException:()=>me,FileCorruptedException:()=>Q,IVException:()=>ne,InternalError:()=>A,InvalidCryptContextTypeException:()=>ae,InvalidEndMarkerException:()=>ee,InvalidFileFormatException:()=>j,InvalidParameterException:()=>g,InvalidScryptParameterException:()=>te,NotSupportedException:()=>oe,raise:()=>Re});var h=class extends Error{constructor(t="Encryption Error",n=void 0){super(t,n),this.name="EncryptionError"}},A=class extends h{constructor(t="(Internal Error)",n=void 0){super(t,n),this.name="InternalError"}};function Re(e,t){throw new A(e,t)}var g=class extends h{constructor(t="The parameter provided is invalid.",n=void 0){super(t,n),this.name="InvalidParameterException"}},$=class extends h{constructor(t="The data is bad.",n=void 0){super(t,n),this.name="BadDataException"}},te=class extends h{constructor(t="The N, r, or p is not valid or out of range.",n=void 0){super(t,n),this.name="InvalidScryptParameterException"}},U=class extends h{constructor(t="The version of the encryption library doesn't match.",n=void 0){super(t,n),this.name="EncryptionVersionMismatchException"}},j=class extends h{constructor(t="The file format is invalid.",n=void 0){super(t,n),this.name="InvalidFileFormatException"}},ne=class extends h{constructor(t="IV Exception.",n=void 0){super(t,n),this.name="IVException"}},Q=class extends h{constructor(t="File is corrupted.",n=void 0){super(t,n),this.name="FileCorruptedException"}},ee=class extends h{constructor(t="The end marker is invalid.",n=void 0){super(t,n),this.name="InvalidEndMarkerException"}},Y=class extends h{constructor(t="Cannot decrypt",n=void 0){super(t,n),this.name="CannotDecryptException"}},re=class extends h{constructor(t="Not allowed to reuse a crypt context.",n=void 0){super(t,n),this.name="CryptContextReusedException"}},oe=class extends h{constructor(t="Operation not supported",n=void 0){super(t,n),this.name="NotSupportedException"}},me=class extends h{constructor(t="End of File",n=void 0){super(t,n),this.name="EndOfFileException"}},ie=class extends h{constructor(t="Crypt context is not initialized.",n=void 0){super(t,n),this.name="CryptContextNotInitedException"}},ae=class extends h{constructor(t="Invalid crypt context type.",n=void 0){super(t,n),this.name="InvalidCryptContextTypeException"}},se=class extends h{constructor(t="Crypt context has been released.",n=void 0){super(t,n),this.name="CryptContextReleasedException"}};var Z=await Ie("scrypt",import.meta.resolve("./WebScrypt/scrypt.js"));Z.setResPath(import.meta.resolve("./WebScrypt/asset/"));Z.load();var Ee=function(){let e=[],t=!1,n=a=>new Promise(async(o,p)=>{Z.onprogress=s=>{a.onprogress&&a.onprogress(s)},Z.oncomplete=s=>{a.resolve(s),o(!0)},Z.onerror=s=>{a.reject(s),o(!1)};try{Z.config({N:a.N,r:a.r,P:a.p},{maxPassLen:8192,maxSaltLen:2048,maxDkLen:1024,maxThread:1}),await new Promise(s=>Z.onready=s),Z.hash(a.key,a.salt,a.dklen)}catch(s){p(s)}});async function i(){let a=null;for(;e.length;)try{a=e.splice(0,1)[0],await n(a),await Me()}catch(o){a?.reject(o)}t=!1}return function(o,p,s,r,c,u,y=null){return new Promise((f,_)=>{e.push({key:o,salt:p,N:s,r,p:c,dklen:u,resolve:f,reject:_,onprogress:y}),t||(t=!0,setTimeout(i))})}}(),De=["Furina","Neuvillette","Venti","Nahida","Kinich","Kazuha"];async function z(e,t,n=null,i=null,a=null,o=8,p=1,s=32){if(i===null&&(i=262144),typeof i!="number"||i>2097152)throw new te;if(a||(a=L(64)),n||(n=De[_e()%De.length]),n.includes(":"))throw new g('phrase MUST NOT contain ":"');let r=`${n}:${K(a)}`,c=`MyEncryption/1.1 Fontaine/4.2 Iv/${K(t)} user_parameter=${r} user_key=${e}`;return{derived_key:await Ee(k(c),a,i,o,p,s),parameter:r,N:i}}function Me(){return new Promise(e=>setTimeout(e))}async function Se(e,t,n,i,a,o){return K(await Ee(k(e),k(t),n,i,a,o))}function Fe(e){try{return JSON.parse(e)}catch{throw new g("The JSON is not valid.")}}async function q(e,t,n=null,i=null){let a=L(12),{derived_key:o,parameter:p,N:s}=await z(t,a,n,i);i=s;let r=await crypto.subtle.importKey("raw",o,"AES-GCM",!1,["encrypt"]);typeof e=="string"&&(e=k(e));let c=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},r,e),u=new Uint8Array(a.length+c.byteLength);u.set(a,0),u.set(new Uint8Array(c),a.length);let y=K(u);return JSON.stringify({data:y,parameter:p,N:i,v:5.5})}async function T(e,t){let n=Fe(e),i=n.parameter,a=parseInt(n.N),o=V(n.data),[p,s]=i.split(":"),r=V(s);if(isNaN(a)||!i||!o||!r)throw new $("The message or parameters are bad.");if(o.length<28)throw new $("The message was too short.");let c=o.slice(0,12),u=o.slice(12,-16),y=o.slice(-16),{derived_key:f}=await z(t,c,p,a,r),_=await crypto.subtle.importKey("raw",f,"AES-GCM",!1,["decrypt"]);try{let w=await crypto.subtle.decrypt({name:"AES-GCM",iv:c},_,new Uint8Array([...u,...y]));try{return x(w)}catch{return w}}catch(w){if(!w)throw new A("Internal error.",{cause:w});let v=w.name;if(v==="InvalidAccessError")throw new g("InvalidAccessError.",{cause:w});if(v==="OperationError")throw new Y("Cannot decrypt. Did you provide the correct password?",{cause:w});if(!w)throw new A("Unexpected error.",{cause:w})}}function Ae(){return new Promise(e=>requestAnimationFrame(e))}var R=4096,ge=[85,170,85,170,85,170,85,170],de=[85,170,85,170,85,170,85,170,170,85,170,85,170,85,170,85,85,170,85,170,85,170,85,170,170,85,170,85,170,85,170,85],fe=[85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170,85,170],ce=[255,253,240,16,19,208,18,24,85,170];function J(e,t){return e?(String(e)==="1.1"&&(t=null),t?`${e}/${t}`:`${e}/0`):"Unknown Version"}var pe=J("1.1"),ue=J("1.2",10020);async function Oe(e,t,n,i=null,a=null,o=null,p=32*1024*1024){await t(k("MyEncryption/1.2"));let s=10020,r=new ArrayBuffer(4);new DataView(r).setUint32(0,s,!0),await t(new Uint8Array(r));let c=K(L(64)),u=await q(c,n),y=k(u);if(y.length>R)throw new A("(Internal Error) This should not happen. Contact the application developer.");let f=new ArrayBuffer(4);new DataView(f).setUint32(0,y.length,!0),await t(new Uint8Array(f)),await t(y);let _=new Uint8Array(R-y.length-4).fill(0);await t(_),i?.(0),await Ae();let w=L(12),{derived_key:v,parameter:M,N:I}=await z(c,w,a,o);o=I;let d={parameter:M,N:o,v:5.5,iv:K(w)},N=k(JSON.stringify(d)),B=new ArrayBuffer(4);new DataView(B).setUint32(0,N.length,!0),await t(new Uint8Array(B)),await t(N);let S=new ArrayBuffer(8);new DataView(S).setBigUint64(0,BigInt(p),!0),await t(new Uint8Array(S));let C=0,D=1,m=0,l=new ArrayBuffer(8);new DataView(l).setBigUint64(0,BigInt(D),!0),await t(new Uint8Array(l)),i?.(0);let E=await crypto.subtle.importKey("raw",v,{name:"AES-GCM"},!1,["encrypt"]);for(;;){let O=await e(m,m+p);if(O.length===0)break;let X=O.length<p,H=new ArrayBuffer(12);if(D>=2**64||D>=Number.MAX_SAFE_INTEGER)throw new ne("nonce_counter exceeded the maximum value.");if(new DataView(H).setBigUint64(4,BigInt(D),!0),D++,X){await t(new Uint8Array(de));let le=new ArrayBuffer(8);new DataView(le).setBigUint64(0,BigInt(O.length),!0),await t(new Uint8Array(le))}let G=new Uint8Array(H),we=await crypto.subtle.encrypt({name:"AES-GCM",iv:G},E,O),ye=new Uint8Array(we);await t(ye),C+=O.length,m+=O.length,i?.(C)}await t(new Uint8Array(fe));let F=new ArrayBuffer(8);return new DataView(F).setBigUint64(0,BigInt(C),!0),await t(new Uint8Array(F)),await t(new Uint8Array(ce)),!0}async function Pe(e,t,n,i=null){let a=await e(0,16);if(x(a)!=="MyEncryption/1.1")throw new TypeError("Invalid file format");let o=16,p=await e(o,o+4),s=new DataView(p.buffer).getUint32(0,!0);o+=4;let r=x(await e(o,o+s));o+=1024;let c=await T(r,n),u=await e(o,o+4),y=new DataView(u.buffer).getUint32(0,!0);o+=4;let f=JSON.parse(x(await e(o,o+y)));o+=y;let[_,w]=f.parameter.split(":"),v=V(w),M=V(f.iv),I=f.N;i?.(0),await Ae();let{derived_key:d}=await z(c,M,_,I,v),N=0,B=await crypto.subtle.importKey("raw",d,{name:"AES-GCM"},!1,["decrypt"]);for(;;){let m=await e(o,o+8);if(o+=8,m.every((H,G)=>H===[255,253,240,16,19,208,18,24][G]))break;let l=Number(new DataView(m.buffer).getBigUint64(0,!0)),E=await e(o,o+12);o+=12;let F=await e(o,o+l+16);o+=l+16;let O=F,X=await crypto.subtle.decrypt({name:"AES-GCM",iv:E},B,O);await t(new Uint8Array(X)),N+=X.byteLength,i&&i(N)}let S=await e(o,o+8),C=Number(new DataView(S.buffer).getBigUint64(0,!0));o+=8;let D=await e(o,o+2);if(N!==C)throw new Q("File corrupted: total bytes mismatch");if(!D.every((m,l)=>m===[85,170][l]))throw new ee("Invalid end marker");return!0}async function Ke(e,t,n,i=null){let a=await e(0,13);if(x(a)!=="MyEncryption/")throw new j;let o=x(await e(13,16));if(!["1.1","1.2"].includes(o))throw new U;let p=new DataView((await e(16,20)).buffer).getUint32(0,!0),s=J(o,p),r=20;if(s===pe)return await Pe(e,t,n,i);let c=new DataView((await e(r,r+4)).buffer).getUint32(0,!0),u=x(await e(r+4,r+4+c));if(r+=R,c>R)throw new A("(Internal Error) This should not happen. Contact the application developer.");let y=await T(u,n),f=await e(r,r+4),_=new DataView(f.buffer).getUint32(0,!0);r+=4;let w=JSON.parse(x(await e(r,r+_)));r+=_;let v=w.v;if(![5.5].includes(v))throw new U;let[M,I]=w.parameter.split(":"),d=V(I),N=V(w.iv),B=w.N,S=Number(new DataView((await e(r,r+8)).buffer).getBigUint64(0,!0)),C=Number(new DataView((await e(r+8,r+16)).buffer).getBigUint64(0,!0));r+=16,i?.(0),await Ae();let{derived_key:D}=await z(y,N,M,B,d),m=0,l=!1,E=await crypto.subtle.importKey("raw",D,{name:"AES-GCM"},!1,["decrypt"]);for(;;){let H=await e(r,r+8),G=0;if(H.every((b,P)=>b===ge[P])){let b=await e(r,r+32);if(b.every((P,he)=>P===fe[he])){r+=32;break}if(b.every((P,he)=>P===de[he])){l=!0,r+=32;let P=await e(r,r+8);if(r+=8,G=Number(new DataView(P.buffer).getBigUint64(0,!0)),G===0)break}}let we=l?G:S,ye=new ArrayBuffer(12);new DataView(ye).setBigUint64(4,BigInt(C),!0),C++;let le=await e(r,r+we+16);r+=we+16;let Ue=le;try{let b=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(ye)},E,Ue);await t(new Uint8Array(b)),m+=b.byteLength}catch(b){if(!b)throw new A("Internal error.",{cause:b});let P=b.name;if(P==="InvalidAccessError")throw new g("InvalidAccessError.",{cause:b});if(P==="OperationError")throw new Y("Cannot decrypt. Did you provide the correct password?",{cause:b});if(!b)throw new A("Unexpected error.",{cause:b})}i&&i(m)}let F=await e(r,r+8),O=Number(new DataView(F.buffer).getBigUint64(0,!0));r+=8;let X=await e(r,r+ce.length);if(m!==O)throw new Q("total bytes mismatch");if(!X.every((H,G)=>H===ce[G]))throw new ee;return!0}async function Le(e,t,n){if(e.size<1044)throw new $("Data not enough");if(await e.slice(0,13).text()!=="MyEncryption/")throw new j;let o=await e.slice(13,16).text();if(!["1.1","1.2"].includes(o))throw new U;let p=new DataView(await e.slice(16,20).arrayBuffer()).getUint32(0,!0),s=J(o,p);if(s===pe){let r=new DataView(await e.slice(16,20).arrayBuffer()).getUint32(0,!0),c=await e.slice(20,20+r).arrayBuffer(),u=x(c);return await q(await T(u,t),n)}if(s===ue){if(e.size<16+R)throw new $("Data not enough");let r=new DataView(await e.slice(20,24).arrayBuffer()).getUint32(0,!0),c=await e.slice(24,24+r).arrayBuffer(),u=x(c);return await q(await T(u,t),n)}throw new U}async function je(e,t,n){if(e.size<1044)throw new Error("Data not enough");let i=e.slice(0,16);if(await i.text()!=="MyEncryption/1.1")throw new TypeError("Invalid file format");let o=new DataView(await e.slice(16,20).arrayBuffer()).getUint32(0,!0),p=x(await e.slice(20,20+o).arrayBuffer()),s=await q(await T(p,t),n);if(s.length>1024)throw new Error("(Internal Error) This should not happen. Contact the application developer.");let r=s.length,c=new ArrayBuffer(4);new DataView(c).setUint32(0,r,!0);let y=[i,c,k(s)],f=new Uint8Array(1024-s.length).fill(0);return y.push(f),new Blob(y)}async function ze(e,t,n){if(e.size<1044)throw new Error("Data not enough");if(await e.slice(0,13).text()!=="MyEncryption/")throw new j;let o=await e.slice(13,16).text();if(!["1.1","1.2"].includes(o))throw new U;let p=new DataView(await e.slice(16,20).arrayBuffer()).getUint32(0,!0);if(J(o,p)===pe)return await je(e,t,n);let r=new DataView(await e.slice(20,24).arrayBuffer()).getUint32(0,!0),c=x(await e.slice(24,24+r).arrayBuffer()),u=await q(await T(c,t),n);if(u.length>1024)throw new Error("(Internal Error) This should not happen. Contact the application developer.");let y=u.length,f=new ArrayBuffer(4);new DataView(f).setUint32(0,y,!0);let w=[e.slice(0,20),f,k(u)],v=new Uint8Array(R-u.length-4).fill(0);return w.push(v),new Blob(w)}var ve=Object.create(null);ve[Symbol.toStringTag]="CryptContext";ve.toString=function(){return`${this[Symbol.toStringTag]} Object`};async function xe(e){return e instanceof Promise?await e:e}async function Ge(){let e=Object.create(ve);return e._created=!0,e}async function $e(e){if(!e||e._released)throw new g("Invalid context");for(let t of Reflect.ownKeys(e)){let n=Reflect.get(e,t);n&&(n.release?await xe(n.release()):n.free?await xe(n.free()):n.reset?await xe(n.reset()):n.clear&&await xe(n.clear())),t.startsWith("_")||Reflect.deleteProperty(e,t)}return Object.defineProperty(e,"_released",{value:!0}),!0}var be=class{#t=null;#e={position:null,end:null,data:null};get[Symbol.toStringTag](){return"Stream"}constructor(t){if(typeof t!="function")throw new g("Invalid reader");this.#t=t}async read(t,n,i=null){if(!this.#t)throw new Error("Stream is closed.");if(this.#e.position&&this.#e.end&&this.#e.data&&t>=this.#e.position&&n<=this.#e.end)return this.#e.data.slice(t-this.#e.position,n-this.#e.position);if(i){let o=await this.#t(t,i);return this.#e.position=t,this.#e.end=t+o.length,this.#e.data=o,o.slice(0,n-t)}return await this.#t(t,n)}purge(){this.#e.position=this.#e.data=this.#e.end=null}close(){this.#t=null,this.purge()}};async function Ye(e,t,n,i){if(e._inited)throw new re;Object.defineProperty(e,"_inited",{value:!0}),e._type="@decrypt_stream",e.stream={stream:t,release:()=>e.stream.stream.close()};let a=await t.read(0,13);if(x(a)!=="MyEncryption/")throw new j;let o=x(await t.read(13,16));if(!["1.1","1.2"].includes(o))throw new U;let p=new DataView((await t.read(16,20)).buffer).getUint32(0,!0),s=J(o,p),r=20;if(s!==ue)throw new oe("Cannot perform a streamed decryption on V1.1 files");let c=new DataView((await t.read(r,r+4)).buffer).getUint32(0,!0),u=x(await t.read(r+4,r+4+c));if(r+=R,c>R)throw new A("(Internal Error) This should not happen. Contact the application developer.");let y=await T(u,i),f=await t.read(r,r+4),_=new DataView(f.buffer).getUint32(0,!0);r+=4;let w=JSON.parse(x(await t.read(r,r+_)));r+=_;let v=w.v;if(![5.5].includes(v))throw new U;let[M,I]=w.parameter.split(":"),d=V(I),N=V(w.iv),B=w.N,S=Number(new DataView((await t.read(r,r+8)).buffer).getBigUint64(0,!0)),C=Number(new DataView((await t.read(r+8,r+16)).buffer).getBigUint64(0,!0));r+=16;let{derived_key:D}=await z(y,N,M,B,d),m=await crypto.subtle.importKey("raw",D,{name:"AES-GCM"},!1,["decrypt"]);return e.key=m,e.chunk_size=S,e.nonce_counter=C,e.header_json_length=_,e.size=n,!0}async function Je(e,t,n){if(!e._inited)throw new ie;if(e._type!=="@decrypt_stream")throw new ae(e._type);if(e._released)throw new se;let i=e.stream.stream,a=e.chunk_size,o=e.nonce_counter,p=[],s=20+R+4+e.header_json_length+8+8,r=a+16,c=Math.floor((e.size-s-(80+ce.length))/r),u=Math.max(0,Math.floor(t/a)),y=Math.min(c,Math.floor(n/a));if(y<0||u>c)throw new g("Out of range");let f=async I=>{let d=s+I*r,N=await i.read(d,d+8,d+2*r),B=0;if(N.every((l,E)=>l===ge[E])){let l=await i.read(d,d+32);if(d+=32,l.every((E,F)=>E===fe[F]))return!1;if(l.every((E,F)=>E===de[F])){let E=await i.read(d,d+8);if(d+=8,B=Number(new DataView(E.buffer).getBigUint64(0,!0)),B===0)return!1}}let S=B||a,C=await i.read(d,d+S+16),D=o+I,m=new ArrayBuffer(12);new DataView(m).setBigUint64(4,BigInt(D),!0);try{return await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(m)},e.key,C)}catch(l){if(!l)throw new A("Internal error.",{cause:l});let E=l.name;if(E==="InvalidAccessError")throw new g("InvalidAccessError.",{cause:l});if(E==="OperationError")throw new Y("Cannot decrypt. Did you provide the correct password?",{cause:l});if(!l)throw new A("Unexpected error.",{cause:l})}},_=!1;for(let I=u;I<=y;I++){let d=await f(I);if(!d){_=!0;break}p.push(d)}let w=new Blob(p),v=u*a,M=w.slice(t-v,n-v);return _&&(M.eof=!0),M}var He="Encryption/5.5 FileEncryption/1.2 Patch/0.0";export{pe as ENCRYPTION_FILE_VER_1_1_0,ue as ENCRYPTION_FILE_VER_1_2_10020,W as Exceptions,be as Stream,He as VERSION,ze as change_file_password,Ge as crypt_context_create,$e as crypt_context_destroy,T as decrypt_data,Ke as decrypt_file,Je as decrypt_stream,Ye as decrypt_stream_init,z as derive_key,q as encrypt_data,Oe as encrypt_file,Le as export_master_key,L as get_random_bytes,Te as get_random_int8_number,_e as get_random_uint8_number,K as hexlify,J as normalize_version,Ee as scrypt,Se as scrypt_hex,x as str_decode,k as str_encode,V as unhexlify};
//# sourceMappingURL=main.bundle.js.map
